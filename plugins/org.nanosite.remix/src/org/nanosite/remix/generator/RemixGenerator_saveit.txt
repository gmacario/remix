/*
 * generated by Xtext
 */
package org.nanosite.remix.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.IGenerator
import org.eclipse.xtext.generator.IFileSystemAccess
import org.nanosite.remix.remix.Model
import org.nanosite.remix.remix.Presentation
import java.io.BufferedReader
import java.io.FileReader
import java.io.FileNotFoundException
import java.io.File
import java.io.IOException
import org.nanosite.remix.remix.Module
import java.util.HashMap
import java.util.Map
import org.nanosite.remix.remix.Collection

class RemixGenerator implements IGenerator {
	
	override void doGenerate(Resource resource, IFileSystemAccess fsa) {
		println("RemixGenerator running...")
		for(m : resource.allContents.toIterable.filter(typeof(Model))) {
//			var filebase = resource.URI.segments.last
//			var dotfile = filebase.replace('.', '_') + ".txt"
//			if (m.genPath!=null && !m.genPath.empty)
//				dotfile = m.genPath + "/" + dotfile
			for(pres : m.presentations) {
// 				fsa.generateFile(pres.name + ".txt", pres.generate)
				FileHelper::save(pres.targetFolder, "index.html", pres.generate.toString)
 			}
 		}
	}
	
	def private generate (Presentation pres) {
		// prepare some substitutions
		var substitutions = new HashMap<String,String>
		substitutions.put("%%TITLE%%", pres.title)
		
		// generate html
		val out = pres.genHTML(substitutions)
		
		// copy resources from used modules
		for(m : pres.modules) {
			val srcdir = m.collection.path + "/resources"
			val src = new File(srcdir);
			println("copy from " + srcdir + " to " + pres.targetFolder)
			if (src.exists && src.directory) {
				val target = pres.targetFolder + "/resources"
				FileHelper::copyFolder(src, new File(target))
			}
		}
		
		// return generated html
		return out
	}

	def private genHTML (Presentation pres, Map<String,String> substitutions) '''
		«FOR m : pres.modules»
		<!-- «m.name» @ «m.filename» -->
		«m.filename.loadFile.replace(substitutions)»

		«ENDFOR»
	'''
	
	def private String getTargetFolder (Presentation it) {
		target + File::separator + name
	}

	def private getCollection (Module it) {
		(eContainer as Collection)
	}

	def private String getFilename (Module it) {
		collection.path + File::separator + file
	}
	
	def private loadFile (String filename) {
		var file = new File(filename)
 		var content = new StringBuffer
 		var BufferedReader reader = null
 
 		try {
  			reader = new BufferedReader(new FileReader(file))
  			var String s = null
 
			while ((s = reader.readLine()) != null) {
				content.append(s).append(sep)
			}
		} catch (FileNotFoundException e) {
 			throw e
		} catch (IOException e) {
 			throw e
		} finally {
			try {
				if (reader != null) {
					reader.close
				}
			} catch (IOException e) {
			}
		}
		return content.toString
	}
	
	def private replace (String in, Map<String, String> subst) {
		var String out = in
		for(s : subst.keySet) {
			out = out.replaceAll(s, subst.get(s))	
		}
		out
	}
	
	def private getSep() {
		System::getProperty("line.separator")
	}
}

